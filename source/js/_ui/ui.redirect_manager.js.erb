var redirectManager = {
  locales: <%= data.locale_urls.map {|a| a[:id].downcase } %>,
  updateUrl: function(){
    var locales = this.locales;
    var get_location_call = new XMLHttpRequest();
    var result_country;
    var geo_code;
    get_location_call.onreadystatechange = function() {
      if(get_location_call.readyState == XMLHttpRequest.DONE) {
        if (get_location_call.status == 200 || get_location_call.status == 301 || get_location_call.status == 302 || get_location_call.status == 304) {
          result_country = JSON.parse(get_location_call.responseText);
          geo_code = result_country.country.toLowerCase();
          if(locales.indexOf(geo_code) != -1) {
            if(cookieManager.hasCookie('ss_geo_redir')){
              redirectManager.redirector();
            } else {
              cookieManager.setCookie('ss_geo_redir', geo_code.toUpperCase());
              redirectManager.redirector();
            }
          }
        }
      }
    };
    get_location_call.open("GET", "<%= config[:get_location_host] %>/locations", true);
    get_location_call.setRequestHeader("Content-Type", "text/plain");
    get_location_call.send();
  },
  redirector: function(location){
    var context = urlManager.context();
    var has_cookie = cookieManager.hasCookie('ss_geo_redir');
    var clean_cookie = cookieManager.editCookie('ss_geo_redir');
    var cookie = cookieManager.getCookie('ss_geo_redir');
    var page_title = urlManager.getPageTitle();
    var redirect;

    if(context === 'global-index' && cookie !== 'global'){
      this.redirectTo('/'+clean_cookie+'/');
    }
    else if(context === 'region-index' && clean_cookie !== window.location.pathname.split('/')[1]){
      if(clean_cookie !== ''){
        this.redirectTo('/'+clean_cookie+'/');
      } else {
        this.redirectTo(clean_cookie+'/');
      }
    }
    else if(context === 'global-content' && cookie !== 'global'){
      this.redirectTo('/'+clean_cookie+'/'+window.location.pathname.split('/')[1]+'/');
    }
    else if(context === 'region-content' && clean_cookie !== window.location.pathname.split('/')[1]){
      if(cookie === 'global'){
        this.redirectTo('/'+page_title+'/');
      } else {
        this.redirectTo('/'+clean_cookie+'/'+page_title+'/');
      }
    }
    return redirect;
  },
  redirectTo: function(location){
    if(location){
      window.location = location;
    }
  }
}

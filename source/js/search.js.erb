$(document).ready(function(){
  var locales = <%= data.locales.map { |a| a[:id] } %>;
  $.getJSON('/contents.json', function(data){
    var index = populateIndex(data);
    var contents = contentList(data);

    searchSetup(index, contents);

    function populateIndex(data){
      var index = lunr(function () {
        this.ref('id');
        this.field('title', {boost: 100, store: true, required: true});
        this.field('content', {boost: 50});
        this.field('url', {index: false, store: true});
        for(var i = 0; i < locales.length; i++){
          if(i.id === 'global') {
            this.field('en', {boost: 50});
          } else {
            this.field('en-'+i.id, {boost: 50});
          }
        }
      });

      index.pipeline.remove(lunr.stemmer);
      data.forEach(function(item){
        index.add(item);
      });
      return index;
    }

    function contentList(data){
      var contents = [];
      data.forEach(function(item){
        contents.push(item);
      });
      return contents;
    }

    function searchSetup(index, contents){

      var resultsTemplate = Handlebars.compile($("#results-template").html());
      var searchField = $("#search-field");

      searchField.on('keyup keypress', function(e) {
        var keyCode = e.which || e.keyCode;
        var keyName = e.key || e.keyIdentifier;
        if (keyCode === 13 || keyName === 'Enter') { // the enter key
          e.preventDefault();
          return false;
        }
      });

      searchField.on("input", function(){
        $(".search-results").empty();
        if ($(this).val() < 1) return;
        var query = $(this).val();

        var results = index.search(query);

        Handlebars.registerHelper('ifIn', function(elem, list, options) {
          if(list.indexOf(elem) > -1) {
            return options.fn(this);
          }
          return options.inverse(this);
        });


        $.each(results, function(index, result){
          current_region = window.location.pathname.split('/').join('').toUpperCase();
          if(current_region == '') {
            current_region = 'en';
          } else {
            current_region = 'en-'+current_region;
          }

          content = contents.find(function(obj) { return obj.id === result.ref; });

          if (content && content.page_slug) {
            $(".search-results").append(resultsTemplate({
              // vars sent to handlebars template
              title: content.title,
              page_content: content.content[current_region],
              page_slug: content.page_slug,
              page_locales: content.page_locales,
              current_page_locale: window.location.href.split('/')[3] == '' ? 'en' : 'en-'+window.location.href.split('/')[3].toUpperCase(),
            }));
          }
        });
      });
    }
  });

});
